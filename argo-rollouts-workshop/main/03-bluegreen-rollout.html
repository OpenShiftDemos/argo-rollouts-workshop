<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Blue-Green Rollout :: Argo Rollouts Workshop</title>
    <link rel="canonical" href="https://openshiftdemos.github.io/argo-rollouts-workshop/argo-rollouts-workshop/main/03-bluegreen-rollout.html">
    <link rel="prev" href="02-workshop-overview.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://openshiftdemos.github.io/argo-rollouts-workshop">Argo Rollouts Workshop</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="argo-rollouts-workshop" data-version="main">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Argo Rollouts Workshop</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-getting-started.html">1. Getting Started</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-getting-started.html#cluster-login">Cluster Login</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-getting-started.html#open-web-terminal">Open the Web Terminal</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-workshop-overview.html">2. Workshop Overview</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-workshop-overview.html#workshop-layout">Workshop Layout</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-workshop-overview.html#review-rollout-manager">Review RolloutManager</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-workshop-overview.html#deploy-application">Deploy Application</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-bluegreen-rollout.html">3. Blue-Green Rollout</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#deploy-blue-green-overview">Blue-Green Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#deploy-blue-green-rollout">Deploy Blue-Green Rollout</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Argo Rollouts Workshop</span>
    <span class="version">main</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Argo Rollouts Workshop</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">main</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Argo Rollouts Workshop</a></li>
    <li><a href="03-bluegreen-rollout.html">3. Blue-Green Rollout</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/OpenShiftDemos/argo-rollouts-workshop/edit/main/documentation/modules/ROOT/pages/03-bluegreen-rollout.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Blue-Green Rollout</h1>
<div class="sect1">
<h2 id="blue-green-overview"><a class="anchor" href="#blue-green-overview"></a>Blue-Green Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In a blue-green deployment we deploy a new version of the application in a separate stack from the current version with
the two versions running in parallel for a period of time. This enables testing on the new version while users continue
to access the current version of the application until a cut-over of traffic happens.</p>
</div>
<div class="paragraph">
<p>The diagram below shows this process over time.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/overview-blue-green.png" alt="overview blue green">
</div>
</div>
<div class="paragraph">
<p>In traditional infrastructure this approach can very challenging and while Kubernetes is simpler due to it&#8217;s declarative nature the process still tends to be cumbersome to manage since bespoke automation needs to be created to manage the separate stacks,
testing and traffic management between versions.</p>
</div>
<div class="paragraph">
<p>This is where Argo Rollouts comes in, it greatly reduces the complexity by providing these capabilities with a simple, declarative approach. In this module
we will deploy a simple blue-green Rollout and explore it&#8217;s basic capabilities.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-blue-green-rollout"><a class="anchor" href="#deploy-blue-green-rollout"></a>Deploy Blue-Green Rollout</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here we will deploy the blue-green rollout in the <code>user%USERNUM%-prod</code> namespace following the same process that we did for the Deployment in the previous module. Prior to starting,
confirm you are still at the correct path.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd ~/argo-rollouts-workshop/documentation/modules/ROOT/examples/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, let&#8217;s explore the manifests that we will be deploying in the <code>./bluegreen/base</code> folder:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ls ./bluegreen/base</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that this time we have files for <code>rollout.yaml</code>, <code>services.yaml</code> and <code>routes.yaml</code> which represent our Rollout, Services and Routes. We also have
<code>kustomization.yaml</code> as per the last module.</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/OpenShiftDemos/argo-rollouts-workshop/blob/main/documentation/modules/ROOT/examples/bluegreen/base/rollout.yaml" target="_blank" rel="noopener">./bluegreen/base/rollout.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: rollouts-demo
spec:
  replicas: 2
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: rollouts-demo
  template:
    metadata:
      labels:
        app: rollouts-demo
    spec:
      containers:
      - name: rollouts-demo
        image: quay.io/openshiftdemos/rollouts-demo:blue
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8080
  strategy:
    blueGreen:
      activeService: active
      previewService: preview
      autoPromotionEnabled: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that the structure of the Rollout is quite similar to the Deployment, it still uses the standard
Kubernetes <a href="https://kubernetes.io/docs/concepts/workloads/pods/#pod-templates" target="_blank" rel="noopener">PodTemplate</a> but note that
under <code>.spec.strategy</code> we have specified the <code>blueGreen</code> strategy. The Kubernetes Deployment object supports <code>rollout</code>
and <code>replace</code> strategies whereas Argo Rollouts supports <code>blueGreen</code> and <code>canary</code> strategies.</p>
</div>
<div class="paragraph">
<p>Under the <code>blueGreen</code> strategy we have identified the active and preview Kubernetes services for the rollout which will be covered
in more detail when services are discussed next.</p>
</div>
<div class="paragraph">
<p>As well as services the field <code>autoPromotionEnabled</code> is set to <code>true</code> which means the rollout will automatically promote the new
version of the application without any human intervention. The Argo Rollouts documentation provides a complete list
of all of the <a href="https://argo-rollouts.readthedocs.io/en/stable/features/bluegreen/#configurable-features" target="_blank" rel="noopener">configurable features</a> for the blueGreen strategy
and additional features will be explored as we progress through the workshop.</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/OpenShiftDemos/argo-rollouts-workshop/blob/main/documentation/modules/ROOT/examples/bluegreen/base/services.yaml" target="_blank" rel="noopener">./bluegreen/base/services.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Service
metadata:
  labels:
    app: rollouts-demo
  name: active
spec:
  ports:
  - port: 8080
    protocol: TCP
    targetPort: 8080
    name: http
  selector:
    app: rollouts-demo
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: rollouts-demo
  name: preview
spec:
  ports:
  - port: 8080
    protocol: TCP
    targetPort: 8080
    name: http
  selector:
    app: rollouts-demo</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the services we define two services, an active service and a preview service. The active service is the service that users of the application will be
interacting with, the preview service would be used to access the new version of the application for testing purposes. As per the <a href="https://argo-rollouts.readthedocs.io/en/stable/features/bluegreen/#overview" target="_blank" rel="noopener">documentation</a>,
Argo Rollouts automatically manages the traffic between the services by managing the <code>.spec.selector</code>.</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/OpenShiftDemos/argo-rollouts-workshop/blob/main/documentation/modules/ROOT/examples/bluegreen/base/routes.yaml" target="_blank" rel="noopener">./bluegreen/base/routes.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: active
spec:
  port:
    targetPort: http
  tls:
    insecureEdgeTerminationPolicy: Redirect
    termination: edge
  to:
    kind: Service
    name: active
---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: preview
spec:
  port:
    targetPort: http
  tls:
    insecureEdgeTerminationPolicy: Redirect
    termination: edge
  to:
    kind: Service
    name: preview</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally we have two Route objects for active and preview with each tied to their respective service.</p>
</div>
<div class="paragraph">
<p>To deploy the blue-green rollout, use the following command to process the kustomization:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -k ./bluegreen/base -n user%USERNUM%-prod</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you have run the command we can confirm that the rollout has deployed successfully. Use the following command to ensure
that the pods are up and running:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pods -l app=rollouts-demo -n user%USERNUM%-prod</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We are getting pods using the label <code>app=rollouts-demo</code> to specifically select pods from the rollout, remember
the RolloutManager pod is also deployed in the <code>user%USERNUM%-prod</code> namespace.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The console should return something along the lines of</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                             READY   STATUS    RESTARTS   AGE
rollouts-demo-66d84bcd76-pxtnc   1/1     Running   0          64s
rollouts-demo-66d84bcd76-q49wt   1/1     Running   0          64s</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are two pods since the Rollout again specified two replicas.</p>
</div>
<div class="paragraph">
<p>Next Open the Route for this application. It&#8217;s in the <code>user%USERNUM%-dev1</code> Project.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get routes -n user%USERNUM%-prod'</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME      HOST/PORT                                                             PATH   SERVICES   PORT   TERMINATION     WILDCARD
active    active-user1-prod.apps.cluster-nh5nw.nh5nw.sandbox2534.opentlc.com           active     http   edge/Redirect   None
preview   preview-user1-prod.apps.cluster-nh5nw.nh5nw.sandbox2534.opentlc.com          preview    http   edge/Redirect   None</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy the value of the <code>HOST/PORT</code> of each route into an individual browser tab to confirm that both display the application with blue squares.</p>
</div>
<div class="paragraph">
<p>Next let&#8217;s examine the active and preview services that were deployed, run the following command to see the active service.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get svc active -o yaml -n user%USERNUM%-prod | oc neat</code></pre>
</div>
</div>
<div class="paragraph">
<p>The console should display the service definition similar to the following:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">apiVersion: v1
kind: Service
metadata:
  annotations:
    argo-rollouts.argoproj.io/managed-by-rollouts: rollouts-demo
  labels:
    app: rollouts-demo
  name: active
  namespace: user1-prod
spec:
  clusterIP: 172.30.104.238
  clusterIPs:
  - 172.30.104.238
  internalTrafficPolicy: Cluster
  ipFamilies:
  - IPv4
  ipFamilyPolicy: SingleStack
  ports:
  - name: http
    port: 8080
  selector:
    app: rollouts-demo
    rollouts-pod-template-hash: 66d84bcd76</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that the selector has an additional key, <code>rollouts-pod-template-hash</code>, with a hash value. This is how the rollout manages traffic
between the active and preview versions. Since we have not deployed a new image, if you check the preview service you will notice the same
selector there as well.</p>
</div>
<div class="paragraph">
<p>Similar to Kubernetes deployments, each revision, i.e. version, of the Rollout is backed by a <a href="https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/" target="_blank" rel="noopener">ReplicaSet</a>.
This ReplicaSet will have a <code>rollouts-pod-template-hash</code> label in it&#8217;s PodTemplate with a value unique to the revision. Argo Rollouts will automatically ensure that
the selector in the service is pointing to the appropriate revision.</p>
</div>
<div class="paragraph">
<p>To view this, output the manifest for the currently deployed replicaset:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get rs -l app=rollouts-demo -n user%USERNUM%-prod -o yaml | oc neat</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="argo-rollout-dashboard"><a class="anchor" href="#argo-rollout-dashboard"></a>Argo Rollouts Dashboard</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Argo Rollouts dashboard has been deployed in the <code>user%USERNUM%-tools</code> namespace on the cluster for this workshop. To access the dashboard,
run the following command to get the URL for the dashboard for your specific user:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get route -n user%USERNUM%-tools dashboard -o jsonpath='{"https://"}{.spec.host}{"\n"}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy the returned URL into a browser tab to access the dashboard.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argo-rollout-dashboard.png" alt="argo rollout dashboard">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Argo Rollouts Dashboard is intended to be run on the developer&#8217;s laptop and as a result it does not support
authentication or multi-tenancy. For convenience and simplicity it has been deployed on cluster for each user
but this is not recommended as a general practice.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the dashboard each rollout will show in it&#8217;s own tile on the overview screen. The tile will provide some
basic information about the tile as shown here:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argo-rollout-dashboard-details.png" alt="argo rollout dashboard details">
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="02-workshop-overview.html" class="query-params-link">2. Workshop Overview</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
