<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Analysis :: Argo Rollouts Workshop</title>
    <link rel="canonical" href="https://openshiftdemos.github.io/argo-rollouts-workshop/argo-rollouts-workshop/main/04-analysis.html">
    <link rel="prev" href="03-bluegreen-rollout.html">
    <link rel="next" href="05-canary-rollout.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://openshiftdemos.github.io/argo-rollouts-workshop">Argo Rollouts Workshop</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="argo-rollouts-workshop" data-version="main">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Argo Rollouts Workshop</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-getting-started.html">1. Getting Started</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-getting-started.html#cluster-login">Cluster Login</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-getting-started.html#open-web-terminal">Open the Web Terminal</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-workshop-overview.html">2. Workshop Overview</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-workshop-overview.html#workshop-namespaces">Workshop Namespaces</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-workshop-overview.html#review-rollout-manager">Review RolloutManager</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-workshop-overview.html#deploy-application">Deploy Application</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-bluegreen-rollout.html">3. Blue-Green Rollout</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-bluegreen-rollout.html#blue-green-strategy">Blue-Green Strategy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-bluegreen-rollout.html#deploy-blue-green-rollout">Deploy Blue-Green Rollout</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-bluegreen-rollout.html#promote-image">Promote Image</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-bluegreen-rollout.html#enable-auto-promotion">Enable Auto-Promotion</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-bluegreen-rollout.html#perform-rollback">Perform Rollback</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-bluegreen-rollout.html#cleanup">Clean-up</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-analysis.html">4. Analysis</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#analysis-overview">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#analysis-deployment">Analysis Deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#analysis-promotion">Promotion with Analysis</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#cleanup">Clean-up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-canary-rollout.html">5. Canary Rollout</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-canary-rollout.html#canary-strategy">Canary Strategy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-canary-rollout.html#deploy-canary-rollout">Deploy Canary Rollout</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-canary-rollout.html#promote-image">Promote Image</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-canary-rollout.html#inline-analysis">Inline Analysis</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-conclusion.html">6. Conclusion</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-conclusion.html#more-resources">More Resources</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Argo Rollouts Workshop</span>
    <span class="version">main</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Argo Rollouts Workshop</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">main</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Argo Rollouts Workshop</a></li>
    <li><a href="04-analysis.html">4. Analysis</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/OpenShiftDemos/argo-rollouts-workshop/edit/main/documentation/modules/ROOT/pages/04-analysis.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Analysis</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this module we will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Review and understand the concept of an Analysis</p>
</li>
<li>
<p>Deploy a Blue-Green rollout with an Analysis</p>
</li>
<li>
<p>Perform a successful promotion of an image tested by an Analysis</p>
</li>
<li>
<p>Perform and observe a promotion that fails an Analysis</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="analysis-overview"><a class="anchor" href="#analysis-overview"></a>Analysis Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When performing upgrades of services there is a need to test the new version
that is being deployed to ensure functionality is not being negatively impacted. The
<a href="https://argo-rollouts.readthedocs.io/en/stable/features/analysis" target="_blank" rel="noopener">Analysis</a> feature
enables Rollouts to collect data and metrics from a variety of providers to validate the
new version of the application.</p>
</div>
<div class="paragraph">
<p>In addition to collecting data, an Analysis can include a Job to drive more advanced use cases. For example
a Job could be used to run load against an application in order to generate the metrics needed to
validate the revision.</p>
</div>
<div class="paragraph">
<p>To deploy an Analysis, first an AnalysisTemplate is created that defines the analysis that is required
and then is associated with one or more rollouts. The way an analysis is associated with a rollout is dependent on
the rollout strategy used. In this module we will look at it from the perspective of the Blue-Green
strategy we have deployed previously however in the next module we delve into it for the Canary strategy as well.</p>
</div>
<div class="paragraph">
<p>In the blue-green strategy, an Analysis can be added as either pre-promotion or post-promotion. Pre-promotion
is used before the new version is deployed and is useful for validating the deployment prior to cutting over to it
for live traffic. Post-promotion is executed after the cut-over and can validate that the deployment is working
with live traffic.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="analysis-deployment"><a class="anchor" href="#analysis-deployment"></a>Analysis Deployment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section we will deploy the same Blue-Green rollout we did previously but with
a pre-promotion analysis included along with the corresponding analysis template. Prior to starting,
confirm you are still at the correct path.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd ~/argo-rollouts-workshop/documentation/modules/ROOT/examples/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, let&#8217;s explore the manifests that we will be deploying in the <code>./bluegreen-analysis/base</code> folder:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ls ./bluegreen-analysis/base</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here you will see the same files that we used previously, however there is a new file <code>analysistemplate.yaml</code>. Examining
the file we see it appears as follows:</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/OpenShiftDemos/argo-rollouts-workshop/blob/main/documentation/modules/ROOT/examples/bluegreen-analysis/base/analysistemplate.yaml" target="_blank" rel="noopener">./bluegreen-analysis/base/analysistemplate.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">kind: AnalysisTemplate
apiVersion: argoproj.io/v1alpha1
metadata:
  name: smoke-tests
spec:
  args:
  - name: query
  - name: route-url
  - name: api-token
    valueFrom:
      secretKeyRef:
        name: monitor-auth-secret
        key: token
  metrics:
  - name: success-rate
    interval: 30s
    count: 4
    # Prometheus queries return results in the form of a vector so it is
    # common to access the index 0 of the returned array to obtain the value
    successCondition: result[0].value[1] == '0'
    failureLimit: 0
    provider:
      web:
        url: <a href="https://thanos-querier.openshift-monitoring:9091/api/v1/query?query={{" class="bare">https://thanos-querier.openshift-monitoring:9091/api/v1/query?query={{</a> args.query }}
        insecure: true
        headers:
          - key: Authorization
            value: "Bearer {{args.api-token}}"
        jsonPath: "{$.data.result}"
  - name: run-load
    provider:
      job:
        spec:
          backoffLimit: 1
          template:
            spec:
              containers:
              - name: siege
                image: quay.io/gnunn/tools:latest
                command: [sh, -c]
                args: ["siege -c 20 -r 15 -d10 -v <a href="http://{{args.route-url}}"" class="bare">http://{{args.route-url}}"</a>]
              restartPolicy: Never</code></pre>
</div>
</div>
<div class="paragraph">
<p>This AnalysisTemplate is broken up into two broad sections as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>.spec.args</code>. This is where you can specify arguments which are passed by the rollout when using the template. These arguments
enable the template to be reused across many different rollouts.</p>
</li>
<li>
<p><code>.spec.metrics</code>. These are the metric providers that will be used to collect data for the analysis as well as any jobs
that need to be executed.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the metrics provider section we can see we have two providers defined, one that uses the web metric provider to pull
metrics from Thanos, an aggregator for Prometheus data, and a job that runs <a href="https://github.com/JoeDog/siege" target="_blank" rel="noopener">Apache Siege</a>
to drive some load on the application.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We are using the web metric provider here since the Argo Rollouts v1.2 that we are using does not
support authentication with the Prometheus provider. This capability has been recently added in Rollouts as
of v1.6.0.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>count</code> and <code>interval</code> fields in the <code>success-rate</code> metric powered by the web provider indicate that the metric will be checked four times
with a thirty second interval between each check. The <code>failureLimit</code> determines how many failures are permitted for the rollout to be considered
a success, here we set a failure limit of 0.</p>
</div>
<div class="paragraph">
<p>Finally, remember we are running this Analysis in the pre-promotion phase of the blue-green strategy so the application will not
be receiving load from users, therefore generating load with Apache Siege will generate the metrics we need to determine whether
to proceed with the promotion.</p>
</div>
<div class="paragraph">
<p>In the arguments we are taking two key arguments, <code>query</code> and <code>route-url</code>, which will be passed from the
Rollout. Notice that the <code>query</code> argument is being used at the end of the URL of the web provider as a
query parameter, this is the Prometheus query that we want to execute against the OpenShift monitoring stack.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>provider:
  web:
    url: https://thanos-querier.openshift-monitoring:9091/api/v1/query?query={{ <strong>args.query</strong> }}</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>route-url</code> parameter is being used in the second provider, the job, where we will be creating load against. This
parameter is used to specify the OpenShift route URL where we want to drive the load, i.e the URL that
siege will be hitting when it generates load.</p>
</div>
<div class="paragraph">
<p>Finally a third parameter, <code>api-token</code>, is provided by a secret. This secret provides the token needed
to access the OpenShift monitoring stack, it was created by the GitOps process which provisioned this workshop.</p>
</div>
<div class="paragraph">
<p>Next let&#8217;s look at the rollout and see how the AnalysisTemplate is wired into the rollout.</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/OpenShiftDemos/argo-rollouts-workshop/blob/main/documentation/modules/ROOT/examples/bluegreen-analysis/base/rollout.yaml" target="_blank" rel="noopener">./bluegreen-analysis/base/rollout.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: rollouts-demo
spec:
  replicas: 2
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: rollouts-demo
  strategy:
    blueGreen:
      activeService: active
      previewService: preview
      autoPromotionEnabled: true
      prePromotionAnalysis:
        args:
        - name: query
          # Note encoded so it can be used as a query parameter, unencode:
          # irate(haproxy_backend_http_responses_total{exported_namespace='rollouts-demo-prod',route=~'preview',code='5xx'}[1m])&gt;10 or on() vector(0)
          value: irate(haproxy_backend_http_responses_total%7Bexported_namespace='user%USER%-prod',route=~'preview',code='5xx'%7D%5B1m%5D)%3E10%20or%20on()%20vector(0)
        - name: route-url
          value: preview-user%USER%-prod.%SUB_DOMAIN%
        templates:
        - templateName: smoke-tests
  template:
    metadata:
      labels:
        app: rollouts-demo
    spec:
      containers:
      - image: quay.io/openshiftdemos/rollouts-demo:blue
        imagePullPolicy: IfNotPresent
        name: rollouts-demo
        ports:
        - containerPort: 8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that in <code>.spec.strategy.blueGreen</code> we have now defined the <code>prePromotionAnalysis</code> field. In this field
we define the analysis template we want to use as well as the arguments that the rollout needs to provide the
template.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The query parameter is URL encoded since we are using the Web provider rather then the Prometheus
provider hence the need to encode it appropriately.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next to deploy this new version of the blue-green rollout, execute the following command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kustomize build ./bluegreen-analysis/base | sed "s/%SUB_DOMAIN%/$SUB_DOMAIN/" | sed "s/%USER%/%USERNUM%/" | oc apply -n user%USERNUM%-prod -f -</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check that the rollout has deployed successfully in the Argo Rollouts dashboard, if you have
closed the browser tab with the dashboard remember the URL can be retrieved as follows:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get route -n user%USERNUM%-tools dashboard -o jsonpath='{"https://"}{.spec.host}{"\n"}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The dashboard for our blue-green rollout will appear identically as follows:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argo-rollout-dashboard-bg-analysis-initial.png" alt="argo rollout dashboard bg analysis initial">
</div>
</div>
<div class="paragraph">
<p>Next confirm that the application is displaying blue squares by opening the active route URL in your browser:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get route -n user%USERNUM%-prod active -o jsonpath='{"https://"}{.spec.host}{"\n"}'</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/rollouts-demo-app-blue.png" alt="rollouts demo app blue">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="analysis-promotion"><a class="anchor" href="#analysis-promotion"></a>Promotion with Analysis</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section we will promote new images using the Analysis to test the new version of the
application. In the first part we will perform a promotion where the analysis succeeds and
the promotion occurs. In the second part we will have the application trigger errors causing
the analysis to fail and the promotion to be aborted.</p>
</div>
<div class="paragraph">
<p>Note that auto-promotion is enabled.</p>
</div>
<div class="sect2">
<h3 id="_analysis_passes"><a class="anchor" href="#_analysis_passes"></a>Analysis Passes</h3>
<div class="paragraph">
<p>With the updated blue-green rollout deployed, let&#8217;s run through a promotion to a new image where
the analysis succeeds and observe the behavior. In the OpenShift console, go to the Pipelines
and do a promotion to a <code>green</code> image. As a reminder this is located here in the console:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/console-pipelines-overview.png" alt="console pipelines overview">
</div>
</div>
<div class="paragraph">
<p>Wait for the pipelines to complete and then go to the Argo Rollouts dashboard where
you may see the following if the Analysis is still running where the Analysis button
is shown in grey (highlighted in the image with a red outline):</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argo-rollouts-analysis-in-progress-overview.png" alt="argo rollouts analysis in progress overview">
</div>
</div>
<div class="paragraph">
<p>When a promotion of a rollout with an analysis is executed the controller will
generate an analysis run for each template execution. Since we only have one template
being used in pre-promotion we will only see one analysis run being created however
it is possible for a promotion to have multiple analysis runs dependent on the
rollout configuration, i.e. in blue-green defining both pre and post promotion analysis.</p>
</div>
<div class="paragraph">
<p>Clicking on the analysis button will expand the view to show the in-progress analysis
that is running:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argo-rollouts-analysis-in-progress-details.png" alt="argo rollouts analysis in progress details">
</div>
</div>
<div class="paragraph">
<p>Note there are two green boxes with graph icons that are being shown in separate
rows. Each row represents a provider and if you recall we had two providers, the job running
Siege and the metric provider. Hovering the mouse over the buttons will display
additional information:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argo-rollouts-analysis-in-progress-hover.png" alt="argo rollouts analysis in progress hover">
</div>
</div>
<div class="paragraph">
<p>Once the analysis is complete the Analysis button will go green to show that it successfully
completed:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argo-rollouts-analysis-completed.png" alt="argo rollouts analysis completed">
</div>
</div>
<div class="paragraph">
<p>Notice that one row has four graph icons, this represents the four measurements that were taken
during the execution of the AnalysisRun. Hovering the mouse over any of these graph icons will
show you the measurement result.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You may need to refresh the browser to see new metrics being added to the AnalysisRun depending
on connectivity during the workshop.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can also use the Argo Rollouts CLI to examine the status of the Rollout by executing the <code>get</code>
command that we used earlier:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc argo rollouts get rollout rollouts-demo -n user%USERNUM%-prod</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will display output similar to the following assuming the analysis run has completed executing:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Name:            rollouts-demo
Namespace:       user%USERNUM%-prod
Status:          ✔ Healthy
Strategy:        BlueGreen
Images:          quay.io/openshiftdemos/rollouts-demo:green (stable, active)
Replicas:
  Desired:       2
  Current:       2
  Updated:       2
  Ready:         2
  Available:     2

NAME                                                        KIND         STATUS         AGE    INFO
⟳ rollouts-demo                                             Rollout      ✔ Healthy      6m58s
├──# revision:2
│  ├──⧉ rollouts-demo-5999df6cf9                            ReplicaSet   ✔ Healthy      2m23s  stable,active
│  │  ├──□ rollouts-demo-5999df6cf9-cw5bm                   Pod          ✔ Running      2m23s  ready:1/1
│  │  └──□ rollouts-demo-5999df6cf9-rfgzr                   Pod          ✔ Running      2m23s  ready:1/1
│  └──α rollouts-demo-5999df6cf9-2-pre                      AnalysisRun  ✔ Successful   2m20s  ✔ 5
│     └──⊞ 17525abd-96e7-4abe-bac3-e9f62249a353.run-load.1  Job          ✔ Successful   2m20s
└──# revision:1
   └──⧉ rollouts-demo-66d84bcd76                            ReplicaSet   • ScaledDown   6m58s
      ├──□ rollouts-demo-66d84bcd76-95xh8                   Pod          ◌ Terminating  6m58s  ready:1/1
      └──□ rollouts-demo-66d84bcd76-qq8lt                   Pod          ◌ Terminating  6m58s  ready:1/1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note for the new revision the results of the AnalysisRun is shown with the INFO column
showing a checkmark with a 5. The five shows the aggregated total of four measurement
checks plus the job executing successfully for a total of five.</p>
</div>
</div>
<div class="sect2">
<h3 id="_analysis_fails"><a class="anchor" href="#_analysis_fails"></a>Analysis Fails</h3>
<div class="paragraph">
<p>Now that we have experienced a successful promotion, let&#8217;s examine the behavior when the
application has errors and the analysis fails. To start, open the preview version of the application in a separate
browser tab, remember we can retrieve the route for the preview service by using this command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get route -n user%USERNUM%-prod preview -o jsonpath='{"https://"}{.spec.host}{"\n"}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Slide the error bar as shown below all the way to the right. Notice how all of the flashing
squares have red outlines around them indicating they are returning error messages.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/rollouts-demo-errors.png" alt="rollouts demo errors">
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This section should not be overly timing sensitive since we are
cheating a bit by pre-generating errors. However when we promote the new image the error
setting will be reset back to 0 for the preview service. After the promotion pipeline completes,
immediately switch back to the tab with the preview service and push the error bar
back to 100%.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we will perform a promotion to a yellow image, go back to the OpenShift Pipeline and start it
with the yellow image:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/console-pipeline-promote-yellow.png" alt="console pipeline promote yellow">
</div>
</div>
<div class="paragraph">
<p>As mentioned in the note above, once the pipeline is finished you must immediately switch back
to the preview service and set the error rate to 100%.</p>
</div>
<div class="paragraph">
<p>If you did everything correctly, you should see that the Analysis failed as indicated by the red
button:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argo-rollouts-analysis-failed-details.png" alt="argo rollouts analysis failed details">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If the timing did not work out for you, you can try again by promoting with a different color.
You can see the list of available colors .<a href="https://quay.io/repository/openshiftdemos/rollouts-demo?tab=tags" target="_blank" rel="noopener">here</a>
where each color is simply a tag in our quay.io registry.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you expand the Analysis section, you will see at least one metric test has failed as
pictured above. You can hover the mouse over the failed analysis to see the details.</p>
</div>
<div class="paragraph">
<p>Examining the rollout with the CLI using the previous <code>get</code> command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc argo rollouts get rollout rollouts-demo -n user%USERNUM%-prod</code></pre>
</div>
</div>
<div class="paragraph">
<p>Will now show the following:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Name:            rollouts-demo
Namespace:       user%USERNUM%-prod
Status:          ✖ Degraded
Message:         RolloutAborted: Rollout aborted update to revision 3: Metric "success-rate" assessed Failed due to failed (1) &gt; failureLimit (0)
Strategy:        BlueGreen
Images:          quay.io/openshiftdemos/rollouts-demo:green (stable, active)
Replicas:
  Desired:       2
  Current:       2
  Updated:       0
  Ready:         2
  Available:     2

NAME                                                        KIND         STATUS        AGE    INFO
⟳ rollouts-demo                                             Rollout      ✖ Degraded    23m
├──# revision:3
│  ├──⧉ rollouts-demo-6b8dccb648                            ReplicaSet   • ScaledDown  8m46s  preview,delay:passed
│  └──α rollouts-demo-6b8dccb648-3-pre                      AnalysisRun  ✖ Failed      8m43s  ✔ 1,✖ 1
│     └──⊞ d484ff69-4ef1-4cf1-9a10-1b78530dadc7.run-load.1  Job          ✔ Successful  8m43s
├──# revision:2
│  ├──⧉ rollouts-demo-5999df6cf9                            ReplicaSet   ✔ Healthy     18m    stable,active
│  │  ├──□ rollouts-demo-5999df6cf9-cw5bm                   Pod          ✔ Running     18m    ready:1/1
│  │  └──□ rollouts-demo-5999df6cf9-rfgzr                   Pod          ✔ Running     18m    ready:1/1
│  └──α rollouts-demo-5999df6cf9-2-pre                      AnalysisRun  ✔ Successful  18m    ✔ 5
│     └──⊞ 17525abd-96e7-4abe-bac3-e9f62249a353.run-load.1  Job          ✔ Successful  18m
└──# revision:1
   └──⧉ rollouts-demo-66d84bcd76                            ReplicaSet   • ScaledDown  23m</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cleanup"><a class="anchor" href="#cleanup"></a>Clean-up</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Prior to moving on to the next module we need to perform some clean-up activities. First let&#8217;s reset the Development environment back to blue:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -k ./deploy/base -n user%USERNUM%-dev</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next we will delete the Rollout in the <code>user%USERNUM%-prod</code> so we can start fresh as we explore the canary strategy next.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kustomize build ./bluegreen-analysis/base | sed "s/%SUB_DOMAIN%/$SUB_DOMAIN/" | sed "s/%USER%/%USERNUM%/" | oc delete -n user%USERNUM%-prod -f -</code></pre>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="03-bluegreen-rollout.html" class="query-params-link">3. Blue-Green Rollout</a></span>
  <span class="next"><a href="05-canary-rollout.html" class="query-params-link">5. Canary Rollout</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
