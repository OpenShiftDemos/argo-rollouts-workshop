<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Canary :: Argo Rollouts Workshop</title>
    <link rel="canonical" href="https://openshiftdemos.github.io/argo-rollouts-workshop/argo-rollouts-workshop/main/05-canary-rollout.html">
    <link rel="prev" href="04-analysis.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://openshiftdemos.github.io/argo-rollouts-workshop">Argo Rollouts Workshop</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="argo-rollouts-workshop" data-version="main">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Argo Rollouts Workshop</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-getting-started.html">1. Getting Started</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-getting-started.html#cluster-login">Cluster Login</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-getting-started.html#open-web-terminal">Open the Web Terminal</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-workshop-overview.html">2. Workshop Overview</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-workshop-overview.html#workshop-layout">Workshop Layout</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-workshop-overview.html#review-rollout-manager">Review RolloutManager</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-workshop-overview.html#deploy-application">Deploy Application</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-bluegreen-rollout.html">3. Blue-Green Rollout</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-bluegreen-rollout.html#deploy-blue-green-overview">Blue-Green Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-bluegreen-rollout.html#deploy-blue-green-rollout">Deploy Blue-Green Rollout</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-bluegreen-rollout.html#argo-rollouts-dashboard">Argo Rollouts Dashboard</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-bluegreen-rollout.html#promote-image">Promote Image</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-bluegreen-rollout.html#enable-auto-promotion">Enable Auto-Promotion</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-bluegreen-rollout.html#cleanup">Clean-up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-analysis.html">4. Analysis</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-analysis.html#analysis-overview">Analysis Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-analysis.html#analysis-deployment">Analysis Deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-analysis.html#analysis-promotion">Promotion with Analysis</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-analysis.html#cleanup">Clean-up</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-canary-rollout.html">5. Canary Rollout</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#canary-overview">Canary Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#deploy-canary-rollout">Deploy Canary Rollout</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Argo Rollouts Workshop</span>
    <span class="version">main</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Argo Rollouts Workshop</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">main</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Argo Rollouts Workshop</a></li>
    <li><a href="05-canary-rollout.html">5. Canary Rollout</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/OpenShiftDemos/argo-rollouts-workshop/edit/main/documentation/modules/ROOT/pages/05-canary-rollout.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Canary</h1>
<div class="sect1">
<h2 id="canary-overview"><a class="anchor" href="#canary-overview"></a>Canary Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://argo-rollouts.readthedocs.io/en/stable/features/canary/" target="_blank" rel="noopener">Canary</a> can be thought of as an advanced version of blue-green where instead of an abrupt cut-over
of live traffic between a current and new revision instead traffic is gradually increased to the new
version in increments, or steps. Like the proverbial <a href="https://en.wiktionary.org/wiki/canary_in_a_coal_mine" target="_blank" rel="noopener">canary in the coal mine</a>,
the intent is to allow users to access the new version over time and if unexpected problems occur revert back to the
previous version.</p>
</div>
<div class="paragraph">
<p>This process is depicted in the diagram below where we see how we slowly migrate traffic from
the current version to the new version until the process is completed.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Argo Rollouts does not currently have support for traffic shaping for OpenShift Routes. This
work is in progress and will be available in the future as Rollouts moves to GA status
in OpenShift GitOps.
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/overview-canary.png" alt="overview canary">
</div>
</div>
<div class="paragraph">
<p>To manage the transition of traffic between stable and canary services, Argo Rollouts supports a variety
of <a href="https://argo-rollouts.readthedocs.io/en/stable/features/traffic-management/" target="_blank" rel="noopener">traffic management</a> solutions. In
the absence of a traffic management solution, Rollouts will manage traffic weight on a best effort basis by adjusting
the number of pod replicas associated with each service.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-canary-rollout"><a class="anchor" href="#deploy-canary-rollout"></a>Deploy Canary Rollout</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now we will deploy the canary rollout in the <code>user%USERNUM%-prod</code> namespace following the same process that we did for the
blue-green in the previous modules. Prior to starting, confirm you are still at the correct path.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd ~/argo-rollouts-workshop/documentation/modules/ROOT/examples/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, let&#8217;s explore the manifests that we will be deploying in the <code>./canary/base</code> folder:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ls ./canary/base</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similar to previous modules, note we have files for <code>rollout.yaml</code>, <code>services.yaml</code> and <code>routes.yaml</code> which represent our Rollout, Services and Routes.</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/OpenShiftDemos/argo-rollouts-workshop/blob/main/documentation/modules/ROOT/examples/canary/base/rollout.yaml" target="_blank" rel="noopener">./canary/base/rollout.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: rollouts-demo
spec:
  replicas: 8
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: rollouts-demo
  template:
    metadata:
      labels:
        app: rollouts-demo
    spec:
      containers:
      - name: rollouts-demo
        image: quay.io/openshiftdemos/rollouts-demo:blue
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8080
  strategy:
    canary:
      canaryService: canary
      stableService: stable
      steps:
      - setWeight: 20
      - pause: {}
      - setWeight: 40
      - pause: {duration: 10s}
      - setWeight: 60
      - pause: {duration: 10s}
      - setWeight: 80
      - pause: {duration: 10s}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the canary strategy, like the blue-green strategy, we specify the services to use for stable and canary. However
unlike blue-green we specify a series of steps determining the flow of traffic between services. At each step we
can set the traffic weight, pause or perform an inline analysis.</p>
</div>
<div class="paragraph">
<p>For this example, the first step sets the weight to 20% and then pauses indefinitely since no duration
is specified. This will allow us to observe the behavior of the canary and validate that it is
performing as expected before performing a manual promotion.</p>
</div>
<div class="paragraph">
<p>Once the manual promotion has been performed, the remaining steps will continue to increase the
traffic weight with short pauses between each step. For the pause step the duration can be
specified in seconds, minutes or hours increments.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For the purposes of this workshop the pause sequences are deliberately short, it is common
to have much longer pauses for more complex applications.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next let&#8217;s look at the Kubernetes services that are defined:</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/OpenShiftDemos/argo-rollouts-workshop/blob/main/documentation/modules/ROOT/examples/canary/base/services.yaml" target="_blank" rel="noopener">./canary/base/services.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Service
metadata:
  name: stable
spec:
  ports:
    - name: http
      protocol: TCP
      port: 8080
      targetPort: 8080
  selector:
    app: rollouts-demo
---
apiVersion: v1
kind: Service
metadata:
  name: canary
spec:
  ports:
    - name: http
      protocol: TCP
      port: 8080
      targetPort: 8080
  selector:
    app: rollouts-demo
---
apiVersion: v1
kind: Service
metadata:
  name: all
spec:
  ports:
    - name: http
      protocol: TCP
      port: 8080
      targetPort: 8080
  selector:
    app: rollouts-demo</code></pre>
</div>
</div>
<div class="paragraph">
<p>As expected we have services for stable and canary defined however there is a new service called
all. This service is not managed by the rollout and includes all pods, we will use this service
to observe the behavior of the rollout.</p>
</div>
<div class="paragraph">
<p>As mentioned previously, Argo Rollouts does not currently have support for traffic shaping for
OpenShift Routes. As a result we will be relying on the best effort approach of scaling pods.
The <code>all</code> service will enable us to see this by including all pods.</p>
</div>
<div class="paragraph">
<p>With the services out of the way now examine the routes:</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/OpenShiftDemos/argo-rollouts-workshop/blob/main/documentation/modules/ROOT/examples/canary/base/routes.yaml" target="_blank" rel="noopener">./canary/base/routes.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: stable
spec:
  port:
    targetPort: http
  to:
    kind: Service
    name: stable
---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: canary
spec:
  port:
    targetPort: http
  to:
    kind: Service
    name: canary
---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: all
  annotations:
    haproxy.router.openshift.io/disable_cookies: 'true'
    haproxy.router.openshift.io/balance: roundrobin
spec:
  port:
    targetPort: http
  to:
    kind: Service
    name: all</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have defined a route to match each service that we saw previously. Note for the <code>all</code> route,
OpenShift Route annotations are being used to disable sticky sessions and use round-robin
load balancing. This enables us to observe the split of traffic as Rollouts manage the pod
replicas between stable and canary services.</p>
</div>
<div class="paragraph">
<p>To deploy the canary rollout, use the following command to process the kustomization:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -k ./canary/base -n user%USERNUM%-prod</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you have run the command we can confirm that the rollout has deployed successfully. Use the following command to ensure
that the pods are up and running:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pods -l app=rollouts-demo -n user%USERNUM%-prod</code></pre>
</div>
</div>
<div class="paragraph">
<p>The console should return something similar to:</p>
</div>
<div class="paragraph">
<p>Update list below for eight replicas</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                             READY   STATUS    RESTARTS   AGE
rollouts-demo-66d84bcd76-79c26   1/1     Running   0          20s
rollouts-demo-66d84bcd76-c8mm7   1/1     Running   0          20s
rollouts-demo-66d84bcd76-jcccp   1/1     Running   0          20s
rollouts-demo-66d84bcd76-mt5wc   1/1     Running   0          20s
rollouts-demo-66d84bcd76-npjvk   1/1     Running   0          20s
rollouts-demo-66d84bcd76-pn77f   1/1     Running   0          20s
rollouts-demo-66d84bcd76-r8rmv   1/1     Running   0          20s
rollouts-demo-66d84bcd76-vcv6z   1/1     Running   0          20s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Retrieve the stable route URL using the command below and copy to a browser tab:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get route -n user%USERNUM%-prod stable -o jsonpath='{"https://"}{.spec.host}{"\n"}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The application is running with blue squares for the current version of the application:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/rollouts-demo-app-blue.png" alt="rollouts demo app blue">
</div>
</div>
<div class="paragraph">
<p>If you go to the Argo Rollouts Dashboard you can see that the dashboard displays
the steps that are defined in the rollout. Again, the dashboard URL can be retrieved
through the following command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get route -n user%USERNUM%-tools dashboard -o jsonpath='{"https://"}{.spec.host}{"\n"}'</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argo-rollouts-dashboard-canary.png" alt="argo rollouts dashboard canary">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="promote-image"><a class="anchor" href="#promote-image"></a>Promote Image</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section we will promote a new image and observe the behavior of the canary rollout using
the same pipeline that we used previously. As a reminder, the pipeline can be accessed in
the <code>user%USERNUM%-tools</code> namespace.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/console-pipelines-overview.png" alt="console pipelines overview">
</div>
</div>
<div class="paragraph">
<p>Go ahead and start the pipeline selecting the green image and wait for the pipeline to complete:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/console-promote-params.png" alt="console promote params">
</div>
</div>
<div class="paragraph">
<p>Once the promotion is complete, run this command to see state of the rollout:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc argo rollouts get rollout rollouts-demo -n user%USERNUM%-prod</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see output similar to the following:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Name:            rollouts-demo
Namespace:       user1-prod
Status:          ॥ Paused
Message:         CanaryPauseStep
Strategy:        Canary
  Step:          1/8
  SetWeight:     20
  ActualWeight:  22
Images:          quay.io/openshiftdemos/rollouts-demo:blue (stable)
                 quay.io/openshiftdemos/rollouts-demo:green (canary)
Replicas:
  Desired:       8
  Current:       9
  Updated:       2
  Ready:         9
  Available:     9

NAME                                       KIND        STATUS     AGE    INFO
⟳ rollouts-demo                            Rollout     ॥ Paused   19m
├──# revision:2
│  └──⧉ rollouts-demo-5999df6cf9           ReplicaSet  ✔ Healthy  9m56s  canary
│     ├──□ rollouts-demo-5999df6cf9-5fwsx  Pod         ✔ Running  9m56s  ready:1/1
│     └──□ rollouts-demo-5999df6cf9-sl9pw  Pod         ✔ Running  9m56s  ready:1/1
└──# revision:1
   └──⧉ rollouts-demo-66d84bcd76           ReplicaSet  ✔ Healthy  19m    stable
      ├──□ rollouts-demo-66d84bcd76-79c26  Pod         ✔ Running  19m    ready:1/1
      ├──□ rollouts-demo-66d84bcd76-c8mm7  Pod         ✔ Running  19m    ready:1/1
      ├──□ rollouts-demo-66d84bcd76-mt5wc  Pod         ✔ Running  19m    ready:1/1
      ├──□ rollouts-demo-66d84bcd76-npjvk  Pod         ✔ Running  19m    ready:1/1
      ├──□ rollouts-demo-66d84bcd76-pn77f  Pod         ✔ Running  19m    ready:1/1
      ├──□ rollouts-demo-66d84bcd76-r8rmv  Pod         ✔ Running  19m    ready:1/1
      └──□ rollouts-demo-66d84bcd76-vcv6z  Pod         ✔ Running  19m    ready:1/1
---

Notice that we have two ReplicaSets, one with 2 pods and the other with 7 pods
corresponding to the preview and stable services respectively. Recall in our first step that
 we set a weight of 20% to the canary service.

Next visit the Argo Rollouts Dashboard and note that the the rollout is paused on the `pause`
step:

image::argo-rollouts-dashboard-canary-pause.png[]</code></pre>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="04-analysis.html" class="query-params-link">4. Analysis</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
