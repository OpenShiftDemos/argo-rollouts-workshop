<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Canary :: Argo Rollouts Workshop</title>
    <link rel="canonical" href="https://openshiftdemos.github.io/argo-rollouts-workshop/argo-rollouts-workshop/main/05-canary-rollout.html">
    <link rel="prev" href="04-analysis.html">
    <link rel="next" href="06-conclusion.html">
    <meta name="generator" content="Antora 3.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
<link rel="icon" href="../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="https://openshiftdemos.github.io/argo-rollouts-workshop">Argo Rollouts Workshop</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="argo-rollouts-workshop" data-version="main">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html" class=" query-params-link">Argo Rollouts Workshop</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-getting-started.html">1. Getting Started</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-getting-started.html#cluster-login">Cluster Login</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-getting-started.html#open-web-terminal">Open the Web Terminal</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-workshop-overview.html">2. Workshop Overview</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-workshop-overview.html#workshop-layout">Workshop Layout</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-workshop-overview.html#review-rollout-manager">Review RolloutManager</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-workshop-overview.html#deploy-application">Deploy Application</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-bluegreen-rollout.html">3. Blue-Green Rollout</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-bluegreen-rollout.html#deploy-blue-green-rollout">Deploy Blue-Green Rollout</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-bluegreen-rollout.html#argo-rollouts-dashboard">Argo Rollouts Dashboard</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-bluegreen-rollout.html#promote-image">Promote Image</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-bluegreen-rollout.html#enable-auto-promotion">Enable Auto-Promotion</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="03-bluegreen-rollout.html#cleanup">Clean-up</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-analysis.html">4. Analysis</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-analysis.html#analysis-deployment">Analysis Deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-analysis.html#analysis-promotion">Promotion with Analysis</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-analysis.html#cleanup">Clean-up</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-canary-rollout.html">5. Canary Rollout</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#deploy-canary-rollout">Deploy Canary Rollout</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#promote-image">promote Image</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#inline-analysis">Inline Analysis</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="06-conclusion.html">6. Conclusion</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="06-conclusion.html#more-resources">More Resources</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Argo Rollouts Workshop</span>
    <span class="version">main</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Argo Rollouts Workshop</span>
      <ul class="versions">
        <li class="version is-current">
          <a href="index.html">main</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Argo Rollouts Workshop</a></li>
    <li><a href="05-canary-rollout.html">5. Canary Rollout</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/OpenShiftDemos/argo-rollouts-workshop/edit/main/documentation/modules/ROOT/pages/05-canary-rollout.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Canary</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://argo-rollouts.readthedocs.io/en/stable/features/canary/" target="_blank" rel="noopener">Canary</a> can be thought of as an advanced version of blue-green where instead of an abrupt cut-over
of live traffic between a current and new revision instead traffic is gradually increased to the new
version in increments, or steps. Like the proverbial <a href="https://en.wiktionary.org/wiki/canary_in_a_coal_mine" target="_blank" rel="noopener">canary in the coal mine</a>,
the intent is to allow users to access the new version over time and if unexpected problems occur revert back to the
previous version.</p>
</div>
<div class="paragraph">
<p>This process is depicted in the diagram below where we see how we slowly migrate traffic from
the current version to the new version until the process is completed.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Argo Rollouts does not currently have support for traffic shaping for OpenShift Routes. This
work is in progress and will be available in the future as Rollouts moves to GA status
in OpenShift GitOps.
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/overview-canary.png" alt="overview canary">
</div>
</div>
<div class="paragraph">
<p>To manage the transition of traffic between stable and canary services, Argo Rollouts supports a variety
of <a href="https://argo-rollouts.readthedocs.io/en/stable/features/traffic-management/" target="_blank" rel="noopener">traffic management</a> solutions. In
the absence of a traffic management solution, Rollouts will manage traffic weight on a best effort basis by adjusting
the number of pod replicas associated with each service.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="deploy-canary-rollout"><a class="anchor" href="#deploy-canary-rollout"></a>Deploy Canary Rollout</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now we will deploy the canary rollout in the <code>user%USERNUM%-prod</code> namespace following the same process that we did for the
blue-green in the previous modules. Prior to starting, confirm you are still at the correct path.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd ~/argo-rollouts-workshop/documentation/modules/ROOT/examples/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, let&#8217;s explore the manifests that we will be deploying in the <code>./canary/base</code> folder:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ls ./canary/base</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similar to previous modules, note we have files for <code>rollout.yaml</code>, <code>services.yaml</code> and <code>routes.yaml</code> which represent our Rollout, Services and Routes.</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/OpenShiftDemos/argo-rollouts-workshop/blob/main/documentation/modules/ROOT/examples/canary/base/rollout.yaml" target="_blank" rel="noopener">./canary/base/rollout.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: rollouts-demo
spec:
  replicas: 8
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: rollouts-demo
  template:
    metadata:
      labels:
        app: rollouts-demo
    spec:
      containers:
      - name: rollouts-demo
        image: quay.io/openshiftdemos/rollouts-demo:blue
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8080
  strategy:
    canary:
      canaryService: canary
      stableService: stable
      steps:
      - setWeight: 20
      - pause: {}
      - setWeight: 40
      - pause: {duration: 10s}
      - setWeight: 60
      - pause: {duration: 10s}
      - setWeight: 80
      - pause: {duration: 10s}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the canary strategy, like the blue-green strategy, we specify the services to use for stable and canary. However
unlike blue-green we specify a series of steps determining the flow of traffic between services. At each step we
can set the traffic weight, pause or perform an inline analysis.</p>
</div>
<div class="paragraph">
<p>For this example, the first step sets the weight to 20% and then pauses indefinitely since no duration
is specified. This will allow us to observe the behavior of the canary and validate that it is
performing as expected before performing a manual promotion.</p>
</div>
<div class="paragraph">
<p>Once the manual promotion has been performed, the remaining steps will continue to increase the
traffic weight with short pauses between each step. For the pause step the duration can be
specified in seconds, minutes or hours increments.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For the purposes of this workshop the pause sequences are deliberately short, it is common
to have much longer pauses for more complex applications.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next let&#8217;s look at the Kubernetes services that are defined:</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/OpenShiftDemos/argo-rollouts-workshop/blob/main/documentation/modules/ROOT/examples/canary/base/services.yaml" target="_blank" rel="noopener">./canary/base/services.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Service
metadata:
  name: stable
spec:
  ports:
    - name: http
      protocol: TCP
      port: 8080
      targetPort: 8080
  selector:
    app: rollouts-demo
---
apiVersion: v1
kind: Service
metadata:
  name: canary
spec:
  ports:
    - name: http
      protocol: TCP
      port: 8080
      targetPort: 8080
  selector:
    app: rollouts-demo
---
apiVersion: v1
kind: Service
metadata:
  name: all
spec:
  ports:
    - name: http
      protocol: TCP
      port: 8080
      targetPort: 8080
  selector:
    app: rollouts-demo</code></pre>
</div>
</div>
<div class="paragraph">
<p>As expected we have services for stable and canary defined however there is a new service called
all. This service is not managed by the rollout and includes all pods, we will use this service
to observe the behavior of the rollout.</p>
</div>
<div class="paragraph">
<p>As mentioned previously, Argo Rollouts does not currently have support for traffic shaping for
OpenShift Routes. As a result we will be relying on the best effort approach of scaling pods.
The <code>all</code> service will enable us to see this by including all pods.</p>
</div>
<div class="paragraph">
<p>With the services out of the way now examine the routes:</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/OpenShiftDemos/argo-rollouts-workshop/blob/main/documentation/modules/ROOT/examples/canary/base/routes.yaml" target="_blank" rel="noopener">./canary/base/routes.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: stable
spec:
  port:
    targetPort: http
  tls:
    insecureEdgeTerminationPolicy: Redirect
    termination: edge
  to:
    kind: Service
    name: stable
---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: canary
spec:
  port:
    targetPort: http
  tls:
    insecureEdgeTerminationPolicy: Redirect
    termination: edge
  to:
    kind: Service
    name: canary
---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: all
  annotations:
    haproxy.router.openshift.io/disable_cookies: 'true'
    haproxy.router.openshift.io/balance: roundrobin
spec:
  port:
    targetPort: http
  tls:
    insecureEdgeTerminationPolicy: Redirect
    termination: edge
  to:
    kind: Service
    name: all</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have defined a route to match each service that we saw previously. Note for the <code>all</code> route,
OpenShift Route annotations are being used to disable sticky sessions and use round-robin
load balancing. This enables us to observe the split of traffic as Rollouts manage the pod
replicas between stable and canary services.</p>
</div>
<div class="paragraph">
<p>To deploy the canary rollout, use the following command to process the kustomization:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -k ./canary/base -n user%USERNUM%-prod</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you have run the command we can confirm that the rollout has deployed successfully. Use the following command to ensure
that the pods are up and running:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get pods -l app=rollouts-demo -n user%USERNUM%-prod</code></pre>
</div>
</div>
<div class="paragraph">
<p>The console should return something similar to:</p>
</div>
<div class="paragraph">
<p>Update list below for eight replicas</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">NAME                             READY   STATUS    RESTARTS   AGE
rollouts-demo-66d84bcd76-79c26   1/1     Running   0          20s
rollouts-demo-66d84bcd76-c8mm7   1/1     Running   0          20s
rollouts-demo-66d84bcd76-jcccp   1/1     Running   0          20s
rollouts-demo-66d84bcd76-mt5wc   1/1     Running   0          20s
rollouts-demo-66d84bcd76-npjvk   1/1     Running   0          20s
rollouts-demo-66d84bcd76-pn77f   1/1     Running   0          20s
rollouts-demo-66d84bcd76-r8rmv   1/1     Running   0          20s
rollouts-demo-66d84bcd76-vcv6z   1/1     Running   0          20s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Retrieve the stable route URL using the command below and copy to a browser tab:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get route -n user%USERNUM%-prod stable -o jsonpath='{"https://"}{.spec.host}{"\n"}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The application is running with blue squares for the current version of the application:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/rollouts-demo-app-blue.png" alt="rollouts demo app blue">
</div>
</div>
<div class="paragraph">
<p>If you go to the Argo Rollouts Dashboard you can see that the dashboard displays
the steps that are defined in the rollout. Again, the dashboard URL can be retrieved
through the following command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get route -n user%USERNUM%-tools dashboard -o jsonpath='{"https://"}{.spec.host}{"\n"}'</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argo-rollouts-dashboard-canary.png" alt="argo rollouts dashboard canary">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="promote-image"><a class="anchor" href="#promote-image"></a>Promote Image</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section we will promote a new image and observe the behavior of the canary rollout using
the same pipeline that we used previously. As a reminder, the pipeline can be accessed in
the <code>user%USERNUM%-tools</code> namespace.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/console-pipelines-overview.png" alt="console pipelines overview">
</div>
</div>
<div class="paragraph">
<p>Go ahead and start the pipeline selecting the green image and wait for the pipeline to complete:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/console-promote-params.png" alt="console promote params">
</div>
</div>
<div class="paragraph">
<p>Once the promotion is complete, run this command to see state of the rollout:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc argo rollouts get rollout rollouts-demo -n user%USERNUM%-prod</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see output similar to the following:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Name:            rollouts-demo
Namespace:       user1-prod
Status:          ॥ Paused
Message:         CanaryPauseStep
Strategy:        Canary
  Step:          1/8
  SetWeight:     20
  ActualWeight:  22
Images:          quay.io/openshiftdemos/rollouts-demo:blue (stable)
                 quay.io/openshiftdemos/rollouts-demo:green (canary)
Replicas:
  Desired:       8
  Current:       9
  Updated:       2
  Ready:         9
  Available:     9

NAME                                       KIND        STATUS     AGE    INFO
⟳ rollouts-demo                            Rollout     ॥ Paused   19m
├──# revision:2
│  └──⧉ rollouts-demo-5999df6cf9           ReplicaSet  ✔ Healthy  9m56s  canary
│     ├──□ rollouts-demo-5999df6cf9-5fwsx  Pod         ✔ Running  9m56s  ready:1/1
│     └──□ rollouts-demo-5999df6cf9-sl9pw  Pod         ✔ Running  9m56s  ready:1/1
└──# revision:1
   └──⧉ rollouts-demo-66d84bcd76           ReplicaSet  ✔ Healthy  19m    stable
      ├──□ rollouts-demo-66d84bcd76-79c26  Pod         ✔ Running  19m    ready:1/1
      ├──□ rollouts-demo-66d84bcd76-c8mm7  Pod         ✔ Running  19m    ready:1/1
      ├──□ rollouts-demo-66d84bcd76-mt5wc  Pod         ✔ Running  19m    ready:1/1
      ├──□ rollouts-demo-66d84bcd76-npjvk  Pod         ✔ Running  19m    ready:1/1
      ├──□ rollouts-demo-66d84bcd76-pn77f  Pod         ✔ Running  19m    ready:1/1
      ├──□ rollouts-demo-66d84bcd76-r8rmv  Pod         ✔ Running  19m    ready:1/1
      └──□ rollouts-demo-66d84bcd76-vcv6z  Pod         ✔ Running  19m    ready:1/1</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are a few things of note here. First the status of the Rollout is <code>Paused</code> due
to the pause step with no duration. Second that we have two ReplicaSets, one with 2 pods
and the other with 7 pods corresponding to the preview and stable services respectively.
Recall in our first step that we set a weight of 20% to the canary service.</p>
</div>
<div class="paragraph">
<p>Next visit the Argo Rollouts Dashboard and note that the the rollout is paused on the <code>pause</code>
step:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argo-rollouts-dashboard-canary-pause.png" alt="argo rollouts dashboard canary pause">
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s see the behavior of the routes, first if you check the stable you will see
the blue version of the application:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get route -n user%USERNUM%-prod stable -o jsonpath='{"https://"}{.spec.host}{"\n"}'</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/rollouts-demo-app-blue.png" alt="rollouts demo app blue">
</div>
</div>
<div class="paragraph">
<p>Next if we check the canary version of the application we should see the green version
of the application.</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get route -n user%USERNUM%-prod canary -o jsonpath='{"https://"}{.spec.host}{"\n"}'</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/rollouts-demo-app-green.png" alt="rollouts demo app green">
</div>
</div>
<div class="paragraph">
<p>Finally if we check the version of the application being delivered by the <code>all</code> route
which includes all pods there will be approximately 20% green squares versus 80%
blue squares:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc get route -n user%USERNUM%-prod all -o jsonpath='{"https://"}{.spec.host}{"\n"}'</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/rollouts-demo-app-canary-blue-green.png" alt="rollouts demo app canary blue green">
</div>
</div>
<div class="paragraph">
<p>To promote the rollout, you can either promote it from the dashboard using the <code>Promote</code>
button or you can promote it using the following command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc argo rollouts promote rollouts-demo -n user%USERNUM%-prod</code></pre>
</div>
</div>
<div class="paragraph">
<p>Observe the dashboard once it has been promoted, the dashboard will show the progression
of the steps by highlight each step as it is being executed.</p>
</div>
<div class="paragraph">
<p>Prior to moving on to the next section, perform a cleanup to remove the current rollout
and reset the Deployment in the dev environment back to blue.</p>
</div>
<div class="paragraph">
<p>Update the deployment:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc apply -k ./deploy/base -n user%USERNUM%-dev</code></pre>
</div>
</div>
<div class="paragraph">
<p>Delete the current rollout:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc delete -k ./canary/base -n user%USERNUM%-prod</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="inline-analysis"><a class="anchor" href="#inline-analysis"></a>Inline Analysis</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the last section there was a pause step that provided an opportunity to test the canary
before progressing further. However we can accomplish the same goal my using an analysis. With
respect the canary strategy, an analysis can be performed in the <a href="https://argo-rollouts.readthedocs.io/en/stable/features/analysis/#background-analysis" target="_blank" rel="noopener">background</a>
or as an <a href="https://argo-rollouts.readthedocs.io/en/stable/features/analysis/#inline-analysis">inline</a> analysis.</p>
</div>
<div class="paragraph">
<p>A background analysis happens asynchronously and does not block the progression of steps, however
if the analysis fails it will abort the rollout similar to what we saw in the previous module with
the blue-green strategy. In the case of an inline analysis, the analysis is performed as a step
and will block the progression of the rollout until it completes.</p>
</div>
<div class="paragraph">
<p>The files for this example are in the <code>./canary-analysis/base</code> folder, to view the list of files
perform an <code>ls</code> as follows:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ls ./canary-analysis/base</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the files are identical to the previous example other then the <code>rollout.yaml</code> and the
<code>analysistemplate.yaml</code> file. The AnalysisTemplate being used here is identical to the one
we used in the blue-green example so we will not cover it again here.</p>
</div>
<div class="paragraph">
<p>The one change in the rollout is that it now as an inline analysis step.</p>
</div>
<div class="listingblock">
<div class="title"><a href="https://github.com/OpenShiftDemos/argo-rollouts-workshop/blob/main/documentation/modules/ROOT/examples/canary-analysis/base/rollout.yaml" target="_blank" rel="noopener">./canary-analysis/base/rollout.yaml</a></div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: rollouts-demo
spec:
  replicas: 8
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: rollouts-demo
  template:
    metadata:
      labels:
        app: rollouts-demo
    spec:
      containers:
      - name: rollouts-demo
        image: quay.io/openshiftdemos/rollouts-demo:blue
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8080
  strategy:
    canary:
      canaryService: canary
      stableService: stable
      steps:
      - setWeight: 20
      - analysis:
          templates:
          - templateName: smoke-tests
          args:
            - name: query
              # Note encoded so it can be used as a query parameter, unencode:
              # irate(haproxy_backend_http_responses_total{exported_namespace='rollouts-demo-prod',route=~'rollout-bluegreen-preview',code='5xx'}[1m])&gt;5 or on() vector(0)
              value: irate(haproxy_backend_http_responses_total%7Bexported_namespace='user%USER%-prod',route=~'canary',code='5xx'%7D%5B1m%5D)%3E5%20or%20on()%20vector(0)
            - name: route-url
              value: canary-user%USER%-prod.%SUB_DOMAIN%
      - pause: {duration: 10s}
      - setWeight: 60
      - pause: {duration: 10s}
      - setWeight: 80
      - pause: {duration: 10s}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that the structure of the inline analysis is identical to what was used in the <code>prePromotionAnalysis</code>
in the blue-green rollout with analysis.</p>
</div>
<div class="paragraph">
<p>To deploy the canary with the inline analysis execute the following command:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kustomize build ./canary-analysis/base | sed "s/%SUB_DOMAIN%/$SUB_DOMAIN/" | sed "s/%USER%/%USERNUM%/" | oc apply -n user%USERNUM%-prod -f -</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the command has been executed, verify that the rollout was deployed:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc argo rollouts get rollout rollouts-demo -n user%USERNUM%-prod</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see output as follows:</p>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">Name:            rollouts-demo
Namespace:       user1-prod
Status:          ✔ Healthy
Strategy:        Canary
  Step:          7/7
  SetWeight:     100
  ActualWeight:  100
Images:          quay.io/openshiftdemos/rollouts-demo:blue (stable)
Replicas:
  Desired:       8
  Current:       8
  Updated:       8
  Ready:         8
  Available:     8

NAME                                       KIND        STATUS     AGE    INFO
⟳ rollouts-demo                            Rollout     ✔ Healthy  4m56s
└──# revision:1
   └──⧉ rollouts-demo-66d84bcd76           ReplicaSet  ✔ Healthy  5s     stable
      ├──□ rollouts-demo-66d84bcd76-c4d6j  Pod         ✔ Running  5s     ready:1/1
      ├──□ rollouts-demo-66d84bcd76-f9qvw  Pod         ✔ Running  5s     ready:1/1
      ├──□ rollouts-demo-66d84bcd76-gp9xp  Pod         ✔ Running  5s     ready:1/1
      ├──□ rollouts-demo-66d84bcd76-gpqwj  Pod         ✔ Running  5s     ready:1/1
      ├──□ rollouts-demo-66d84bcd76-k6dwl  Pod         ✔ Running  5s     ready:1/1
      ├──□ rollouts-demo-66d84bcd76-mlj5q  Pod         ✔ Running  5s     ready:1/1
      ├──□ rollouts-demo-66d84bcd76-wp4tj  Pod         ✔ Running  5s     ready:1/1
      └──□ rollouts-demo-66d84bcd76-z8kr2  Pod         ✔ Running  5s     ready:1/1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, examining the Argo Rollouts Dashboard we can see the inline Analysis being shown with the other steps:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argo-rollouts-dashboard-canary-analysis.png" alt="argo rollouts dashboard canary analysis">
</div>
</div>
<div class="paragraph">
<p>Note that since we no longer have a manual pause step the promotion will complete automatically as long as the
analysis step executes successfully.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s do our promotion to the <code>green</code> image, go to the <code>user%USERNUM%-tools</code> namespace and start the pipeline
again. Once the pipeline has completed, observe the behavior of the canary deployment during the process in
the Argo Rollouts Dashboard.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you want to try this multiple times to look at different things feel free to use the pipeline
to deploy different colors. Remember the available colors are available .<a href="https://quay.io/repository/openshiftdemos/rollouts-demo?tab=tags" target="_blank" rel="noopener">here</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the dashboard, if you catch it before it completes, you can see the analysis step executing. Similar to
what we saw in the previous module, the analysis button will be grey while it is executing, green when it
has completed successfully or red if it failed. Here is what the dashboard looks like while the
analysis is executing:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/argo-rollouts-dashboard-analysis-executing.png" alt="argo rollouts dashboard analysis executing">
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="04-analysis.html" class="query-params-link">4. Analysis</a></span>
  <span class="next"><a href="06-conclusion.html" class="query-params-link">6. Conclusion</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../../_/js/vendor/clipboard.js"></script>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
